<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <!-- REGOLA: REVERSE PROXY per le richieste API al backend Node.js -->
        <rule name="Reverse Proxy to Node.js Backend" stopProcessing="true">
          <match url="^api/(.*)" />
          <action type="Rewrite" url="http://localhost:5000/api/{R:1}" />
        </rule>

        <!-- REGOLA: Servire tutti i file statici dalla cartella dist/ -->
        <rule name="Serve Static Files from Dist" stopProcessing="true">
          <match url="^(.*)$" ignoreCase="true" />
          <conditions logicalGrouping="MatchAll">
            <add input="C:\Users\clama\dyad-apps\manutenzioni1\dist\{R:1}" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" url="/dist/{R:1}" />
        </rule>
        
        <!-- REGOLA: Fallback SPA per tutte le altre rotte del client -->
        <rule name="Serve SPA Frontend Client Routes" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/api" negate="true" />
          </conditions>
          <action type="Rewrite" url="/dist/index.html" />
        </rule>
        
      </rules>
    </rewrite>
    
    <staticContent>
      <clear />
      <mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
      <mimeMap fileExtension=".js" mimeType="application/javascript" />
      <mimeMap fileExtension=".css" mimeType="text/css" />
      <mimeMap fileExtension=".png" mimeType="image/png" />
      <mimeMap fileExtension=".svg" mimeType="image/svg+xml" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <mimeMap fileExtension=".html" mimeType="text/html" />
    </staticContent>

    <outboundRules>
      <rule name="RewriteHeaders" preCondition="IsXHR">
        <match serverVariable="RESPONSE_X_Powered_By" pattern=".*" />
        <action type="Rewrite" value="" />
      </rule>
      <preConditions>
        <preCondition name="IsXHR">
          <match input="{RESPONSE_CONTENT_TYPE}" pattern="^text/xml|application/json" />
        </preCondition>
      </preConditions>
    </outboundRules>
    
  </system.webServer>
</configuration>