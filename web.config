<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <!-- Gestisce le richieste al backend Node.js tramite iisnode -->
      <add name="iisnode" path="app.js" verb="*" modules="iisnode" />
      <!-- Gestisce i file statici del frontend -->
      <add name="StaticFile" path="*" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
    </handlers>

    <iisnode      
      node_env="production"
      loggingEnabled="true"
      logDirectory="iisnode"
      watchedFiles="web.config;*.js;dist\backend\server.js"
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
      />

    <rewrite>
      <rules>
        <!-- Regola 1: Inoltra le richieste che iniziano con /api al backend Node.js -->
        <rule name="NodeJS Api" patternSyntax="ECMAScript" stopProcessing="true">
          <match url="^api/(.*)$" />
          <action type="Rewrite" url="app.js" />
        </rule>

        <!-- Regola 2: Serve i file statici se esistono nella cartella dist -->
        <rule name="Static Files" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions logicalGrouping="MatchAll" trackAllCaptures="false">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" url="/dist/{R:1}" />
        </rule>

        <!-- Regola 3: Fallback per il routing del frontend (SPA) -->
        <rule name="SPA Fallback" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll" trackAllCaptures="false">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="/dist/index.html" />
        </rule>
      </rules>
    </rewrite>

    <!-- Impostazioni per i tipi MIME per PWA -->
    <staticContent>
      <!-- Le righe per .json, .js, .css e .svg sono state rimosse perché sono già definite in IIS -->
      <mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
    </staticContent>

    <!-- Nasconde la cartella node_modules -->
    <security>
      <requestFiltering>
        <hiddenSegments>
          <add segment="node_modules" />
        </hiddenSegments>
      </requestFiltering>
    </security>
  </system.webServer>

  <!-- Variabili d'ambiente per il backend Node.js -->
  <appSettings>
    <!-- Sostituisci con i tuoi valori reali -->
    <add key="SUPABASE_URL" value="TUA_SUPABASE_URL" />
    <add key="SUPABASE_SERVICE_ROLE_KEY" value="TUA_SUPABASE_SERVICE_ROLE_KEY" />
    <!-- Se usi MySQL direttamente, aggiungi anche queste -->
    <add key="DB_HOST" value="localhost" />
    <add key="DB_USER" value="root" />
    <add key="DB_PASSWORD" value="TUA_PASSWORD_MYSQL" />
    <add key="DB_NAME" value="manutenzioni" />
    <add key="DB_PORT" value="3306" />
    <!-- La porta per il backend Node.js sarà gestita da iisnode -->
  </appSettings>
</configuration>